# Claude Code Gateway 开发计划

## 项目概述

Claude Code Gateway 是一个企业级 AI API 网关服务，提供统一的 Claude 模型访问入口，支持 OpenAI 和 Anthropic API 风格，具备完整的用户管理、配额控制、使用统计和审批流程。

## 开发阶段划分

### 阶段一：基础架构搭建（第 1-2 周）

#### 1.1 项目初始化
- [x] 创建 Go 项目结构
- [x] 初始化 go.mod，引入核心依赖（Gin、SQLite 驱动、Logrus 等）
- [x] 配置 Git 仓库和 .gitignore
- [x] 创建基础目录结构（cmd、config、internal、web、scripts）

#### 1.2 配置模块开发
- [x] 实现 config.yaml 解析（使用 yaml.v3）
- [x] 定义 Config 和 BackendAPI 结构体
- [x] 实现配置加载和验证逻辑
- [ ] 编写配置模块单元测试

#### 1.3 数据库模块开发
- [x] 集成 modernc.org/sqlite 驱动
- [x] 定义所有数据模型（User、APIKey、UsageLog、Application、DailyStats）
- [x] 实现数据库初始化和自动迁移
- [x] 创建数据库连接池管理
- [ ] 编写数据库操作的基础 CRUD 方法

#### 1.4 日志模块
- [x] 配置 Logrus 结构化日志
- [x] 实现日志中间件（记录请求路径、方法、状态码、耗时）
- [x] 配置日志输出格式和级别

**交付物**：
- 可运行的基础项目框架
- 配置文件加载功能
- 数据库表结构创建和基础操作
- 日志记录功能

---

### 阶段二：认证与用户管理（第 3-4 周）

#### 2.1 验证码登录系统
- [ ] 实现验证码发送接口（调用外部服务）
- [ ] 实现内存验证码存储（带过期时间，5分钟）
- [ ] 实现登录接口（验证码校验）
- [ ] 集成 Gin Session 中间件
- [ ] 实现登出接口

#### 2.2 API Key 管理
- [ ] 实现 API Key 生成算法（sk- 前缀 + 32字节随机字符串）
- [ ] 实现 API Key 数据库 CRUD 操作
- [ ] **实现 API Key 内存加载机制**（启动时全量加载）
- [ ] 实现内存 Key Map 的并发安全访问（sync.RWMutex 或 sync.Map）
- [ ] 实现 Key 状态变更时的内存同步机制
- [ ] 实现 API Key 过期检查逻辑

#### 2.3 用户管理
- [ ] 实现用户 CRUD 接口
- [ ] 实现默认管理员自动创建逻辑
- [ ] 实现用户状态管理（禁用/启用）
- [ ] 实现用户配额设置和查询
- [ ] **实现用户配额内存缓存**

#### 2.4 认证中间件
- [ ] 实现 AuthMiddleware（API Key 验证，全内存查找）
- [ ] 实现 SessionAuthMiddleware（管理后台 Session 验证）
- [ ] 实现 QuotaMiddleware（配额检查，内存缓存）
- [ ] 编写认证中间件单元测试

**交付物**：
- 完整的验证码登录流程
- API Key 生成、管理和验证功能
- 用户管理功能
- 高性能的内存认证机制

---

### 阶段三：代理转发核心（第 5-7 周）

#### 3.1 HTTP 连接池管理
- [ ] 实现后端连接池配置（http.Transport）
- [ ] 配置 MaxIdleConns 和 MaxIdleConnsPerHost
- [ ] 为每个后端创建独立的 HTTP 客户端
- [ ] 实现连接池健康检查

#### 3.2 负载均衡器
- [ ] 实现基于权重的随机选择算法
- [ ] 实现后端健康状态跟踪（错误计数）
- [ ] 实现故障后端自动剔除和恢复机制
- [ ] 编写负载均衡器单元测试

#### 3.3 OpenAI 风格 API 代理
- [ ] 实现 POST /v1/chat/completions 接口
- [ ] 实现请求体解析和验证
- [ ] 实现请求头替换（Authorization）
- [ ] 实现非流式响应转发
- [ ] 实现流式响应（SSE）转发
- [ ] 实现错误处理和重试逻辑

#### 3.4 Anthropic 风格 API 代理
- [ ] 实现 POST /v1/messages 接口
- [ ] 实现 Anthropic 格式请求处理
- [ ] 实现流式和非流式响应转发
- [ ] 实现格式转换（如需要）

#### 3.5 模型列表接口
- [ ] 实现 GET /v1/models 接口
- [ ] 实现模型列表缓存机制
- [ ] 支持从配置或后端动态获取模型列表

**交付物**：
- 高性能的 HTTP 连接池
- 智能负载均衡器
- 完整的 OpenAI 和 Anthropic API 代理功能
- 流式响应支持

---

### 阶段四：统计与监控（第 8-9 周）

#### 4.1 异步统计收集器
- [ ] 实现带缓冲的 channel 用于统计数据传递
- [ ] 实现 worker goroutine 批量写入数据库
- [ ] 实现统计数据结构（UsageLog）
- [ ] 实现 Token 使用量解析（从响应中提取）
- [ ] 实现费用计算逻辑（基于模型单价）
- [ ] 实现 channel 满时的降级策略

#### 4.2 统计聚合器
- [ ] 实现定时任务（基于 usage_sync_time 配置）
- [ ] 实现按天、用户、模型聚合逻辑
- [ ] 实现 DailyStats 表的更新
- [ ] 实现历史数据归档策略

#### 4.3 统计查询接口
- [ ] 实现 GET /admin/api/usage 接口
- [ ] 支持按日期范围、用户、模型筛选
- [ ] 实现统计数据汇总计算
- [ ] 优化查询性能（索引、分页）

#### 4.4 后端 Endpoint 统计
- [ ] 记录每个后端的请求次数、成功率、延迟
- [ ] 实现后端统计查询接口（管理员）
- [ ] 实现统计数据可视化准备

**交付物**：
- 异步、高性能的统计收集系统
- 定时聚合任务
- 完整的使用统计查询接口
- 后端健康监控数据

---

### 阶段五：审批流程（第 10 周）

#### 5.1 申请管理
- [ ] 实现 Application 数据模型
- [ ] 实现用户提交申请接口
- [ ] 实现申请列表查询（用户和管理员）
- [ ] 实现申请状态管理

#### 5.2 审批功能
- [ ] 实现管理员审批接口（approve/reject）
- [ ] 实现审批后的权限更新逻辑
- [ ] 实现审批通知机制（可选）
- [ ] 编写审批流程测试

**交付物**：
- 完整的模型使用申请和审批流程
- 权限管理与审批联动

---

### 阶段六：管理后台前端（第 11-13 周）

#### 6.1 前端项目初始化
- [ ] 创建 React + TypeScript 项目
- [ ] 配置 Tailwind CSS
- [ ] 配置路由（React Router）
- [ ] 配置 API 请求工具（Axios 或 Fetch）

#### 6.2 认证页面
- [ ] 实现登录页面（验证码输入）
- [ ] 实现发送验证码功能
- [ ] 实现登录状态管理
- [ ] 实现登出功能

#### 6.3 用户功能页面
- [ ] 实现仪表盘（使用概览）
- [ ] 实现 API Key 管理页面（列表、创建、禁用、删除）
- [ ] 实现使用统计页面（图表展示）
- [ ] 实现申请提交页面

#### 6.4 管理员功能页面
- [ ] 实现用户管理页面（列表、状态管理、配额设置）
- [ ] 实现审批管理页面（待审批列表、审批操作）
- [ ] 实现后端 Endpoint 统计页面
- [ ] 实现系统配置页面（可选）

#### 6.5 前端优化
- [ ] 实现错误处理和提示
- [ ] 实现加载状态显示
- [ ] 实现响应式布局
- [ ] 前端代码优化和打包

**交付物**：
- 完整的 Web 管理后台
- 用户和管理员功能页面
- 良好的用户体验

---

### 阶段七：集成测试与优化（第 14-15 周）

#### 7.1 集成测试
- [ ] 编写端到端测试用例
- [ ] 测试完整的代理请求流程
- [ ] 测试认证和授权流程
- [ ] 测试统计数据准确性
- [ ] 测试审批流程
- [ ] 压力测试（高并发场景）

#### 7.2 性能优化
- [ ] 分析性能瓶颈（pprof）
- [ ] 优化内存使用
- [ ] 优化数据库查询
- [ ] 优化连接池配置
- [ ] 优化异步统计性能

#### 7.3 安全加固
- [ ] 实现 API Key 加密存储（可选）
- [ ] 实现请求频率限制
- [ ] 实现 SQL 注入防护
- [ ] 实现 XSS 防护
- [ ] 安全审计

#### 7.4 文档完善
- [ ] 编写 API 文档
- [ ] 编写部署文档
- [ ] 编写运维文档
- [ ] 编写用户使用手册

**交付物**：
- 完整的测试覆盖
- 性能优化报告
- 安全加固措施
- 完整的项目文档

---

### 阶段八：部署与上线（第 16 周）

#### 8.1 部署准备
- [ ] 编写 Dockerfile
- [ ] 编写 docker-compose.yml
- [ ] 配置生产环境配置文件
- [ ] 准备数据库备份方案

#### 8.2 部署实施
- [ ] 部署到测试环境
- [ ] 进行灰度测试
- [ ] 部署到生产环境
- [ ] 配置监控和告警

#### 8.3 上线后支持
- [ ] 监控系统运行状态
- [ ] 收集用户反馈
- [ ] 修复紧急 Bug
- [ ] 性能调优

**交付物**：
- 生产环境部署
- 监控和告警系统
- 运维支持

---

## 技术要点与注意事项

### 高性能设计原则

1. **API Key 全内存加载**
   - 启动时加载所有有效 Key 到内存
   - 使用 sync.Map 或 sync.RWMutex 保证并发安全
   - Key 变更时实时更新内存
   - 验证时间复杂度 O(1)

2. **连接池复用**
   - 每个后端独立的 HTTP 连接池
   - 配置合理的 MaxIdleConns
   - 避免频繁 TCP 握手
   - 定期健康检查

3. **异步统计**
   - 使用 channel 解耦统计和转发
   - worker goroutine 批量写入
   - channel 满时降级处理
   - 不阻塞主流程

4. **配额缓存**
   - 用户配额加载到内存
   - 与 API Key 关联
   - 定期同步或事件更新
   - 快速配额检查

5. **零数据库查询**
   - 代理请求路径完全避免查库
   - 所有关键数据常驻内存
   - 仅统计和管理后台查库

### 开发规范

1. **代码规范**
   - 遵循 Go 官方代码规范
   - 使用 golangci-lint 进行代码检查
   - 编写清晰的注释和文档
   - 保持代码简洁和可维护性

2. **测试规范**
   - 单元测试覆盖率 > 80%
   - 关键路径必须有集成测试
   - 使用 table-driven tests
   - Mock 外部依赖

3. **Git 规范**
   - 使用语义化的 commit message
   - 功能开发使用 feature 分支
   - 代码审查后合并到 main
   - 保持提交历史清晰

4. **日志规范**
   - 使用结构化日志
   - 记录用户 itcode
   - 敏感信息脱敏
   - 合理的日志级别

### 风险与挑战

1. **性能风险**
   - 高并发下的内存管理
   - 连接池配置不当导致性能下降
   - 统计数据积压

2. **安全风险**
   - API Key 泄露
   - 配额绕过
   - SQL 注入
   - DDoS 攻击

3. **稳定性风险**
   - 后端服务不可用
   - 数据库锁竞争
   - 内存泄漏

4. **数据一致性**
   - 内存数据与数据库不一致
   - 统计数据丢失
   - 并发更新冲突

### 监控指标

1. **性能指标**
   - 请求 QPS
   - 平均响应时间
   - P99 延迟
   - 错误率

2. **资源指标**
   - CPU 使用率
   - 内存使用率
   - 连接池状态
   - 数据库连接数

3. **业务指标**
   - Token 使用量
   - 费用统计
   - 用户活跃度
   - 后端健康状态

---

## 人员分工建议

- **后端开发（2人）**：负责核心代理、认证、统计模块
- **前端开发（1人）**：负责管理后台开发
- **测试（1人）**：负责测试用例编写和质量保证
- **项目经理（1人）**：负责项目协调和进度管理

---

## 里程碑

- **M1（第2周）**：基础架构完成
- **M2（第4周）**：认证和用户管理完成
- **M3（第7周）**：代理转发核心完成
- **M4（第9周）**：统计监控完成
- **M5（第13周）**：管理后台完成
- **M6（第15周）**：测试和优化完成
- **M7（第16周）**：生产环境上线

---

## 总结

本开发计划基于 PRD 文档，将项目分为 8 个阶段，预计 16 周完成。核心重点是**高性能代理转发**，通过内存加载、连接池复用、异步统计等技术手段，确保代理路径的极致性能。同时提供完整的管理后台和审批流程，满足企业级使用需求。
